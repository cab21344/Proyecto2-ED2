
// Electrónica Digital 2 - Proyecto 2
// María Daniela Cabrera Porras, 21344

// Librerías ******************************************************
#include "driverlib/gpio.h"   // Incluye la biblioteca GPIO.
#include <SPI.h>
#include <SD.h>

//*****************************************************************

// Definiciones ***************************************************
#define botonMedir PF_4
#define botonGuardar PF_0
#define buzzerPin PF_2

#define SCK PA_2  // Pin SCK de la Tiva (PA2)
#define MISO PA_4 // Pin MISO de la Tiva (PA4)
#define MOSI PA_5 // Pin MOSI de la Tiva (PA5)
#define SS PA_3   // Pin SS de la Tiva (PA3)
//*****************************************************************

// Variables ******************************************************
File root; //archivo para SD
int estadoMed = 0;
int estadoGuar = 0;

const int chipSelect = SS;
//*****************************************************************


//***************************************************************
//Void Setup
//***************************************************************
void setup() {
  // initialize both serial ports ***********************
  Serial.begin(115200);
  Serial2.begin(115200);
  SPI.setModule(0);


  //se inicia SD ***********************
  Serial.println("Iniciando tarjeta SD");
  pinMode(chipSelect, OUTPUT);

  if (!SD.begin(chipSelect)) { //pin de la SD
    Serial.println("Inicialización fallida de SD");
    while (true) {} //si falla que se quede en bucle
    }
    Serial.println("Tarjeta SD inicializada"); //mensaje de SD inicializada


  //Indica que se inició comunicación serial ***********************
  Serial.println("Inicio de comunicación serial"); //confimación comunicación serial

  //Inputs y Outputs ***********************
  pinMode(botonMedir, INPUT_PULLUP);
  pinMode(botonGuardar, INPUT_PULLUP);
  pinMode(buzzerPin, OUTPUT);

  noTone(buzzerPin); //que inicie sin sonido

}

//***************************************************************


//Void Loops
//***************************************************************
void loop() {
  //Estados botones
  estadoMed = digitalRead(botonMedir);
  estadoGuar = digitalRead(botonGuardar);
  if (estadoMed == LOW) {
    Serial.println("Medición:");
    Serial2.println("measure");
    //Serial.println(inByte);
    tone(buzzerPin, 500, 500);
    delay(500);
  }

  //Boton 1 - Pide info al ESP32 **************************************************
  if (Serial2.available()) {
    int inByte = Serial2.read();
    Serial.write(inByte);
  }

  if (Serial.available()) {
    int inByte = Serial.read();
  }

  //Boton 2 - Guardar info en la SD **************************************************
  String dataString = "";
  File dataFile = SD.open("datalog.txt", FILE_WRITE);

  if (estadoGuar == LOW) {
    if (dataFile) {
      dataFile.print(dataString);
      dataFile.close();
      Serial.println("Información almacenada en la SD!");
      tone(buzzerPin, 1000, 500);
      delay(500);
    } else {
      Serial.println("Error al almacenar información");
      tone(buzzerPin, 200, 500);
      delay(500);
    }
  }


  delay(100);
  noTone(buzzerPin);
}
